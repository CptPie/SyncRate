{{define "songs.html"}}
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{.title}}</title>
    <link href="/static/css/style.css" rel="stylesheet" />
  </head>
  <body>
    <div class="container">
      {{template "header" .}}
      <main>
        <h2>All Songs</h2>

        <!-- Search and Filter -->
        <div class="search-filter-container">
          <div class="search-filter-row">
            <div class="search-group">
              <label for="song-search" class="form-label">Search Songs</label>
              <input type="text" id="song-search" class="search-input" placeholder="Search by song name, artist, unit, or source URL...">
              <div class="search-stats" id="search-stats">{{len .songs}} songs total</div>
            </div>
            <div class="filter-group">
              <label for="category-filter" class="form-label">Filter by Category</label>
              <select id="category-filter" class="filter-select">
                <option value="">All Categories</option>
              </select>
            </div>
          </div>
        </div>

        <!-- No Results Message -->
        <div id="no-results" class="no-results" style="display: none;">
          <h3>No songs found</h3>
          <p>Try adjusting your search terms or filters</p>
        </div>

        {{if .songs}}
        <div class="song-grid" id="songs-container">
          {{range .songs}}
          <div class="song-card" data-id="{{.SongID}}" data-song-id="{{.SongID}}">
            {{if .ThumbnailURL}}
            <img
              src="{{.ThumbnailURL}}"
              alt="{{.NameOriginal}}"
              class="song-card-image"
            />
            {{end}}
            <h3>
              <a
                href="/songs/{{.SongID}}"
                style="text-decoration: none; color: inherit"
                >{{.NameOriginal}}</a
              >
            </h3>
            {{if .NameEnglish}}
            <p><em>{{.NameEnglish}}</em></p>
            {{end}} {{if .Artists}}
            <div class="artist">
              {{range $index, $songArtist := .Artists}} {{if $index}}, {{end}}<span class="artist-name">{{$songArtist.NameOriginal}}</span> {{end}}
            </div>
            {{end}}
            {{if .Units}}
            <div class="units">
              {{range $index, $songUnit := .Units}} {{if $index}}, {{end}}<span class="unit-name">{{$songUnit.NameOriginal}}</span> {{end}}
            </div>
            {{end}}
            <div class="categories">
              {{if .Category}}
              <span class="category">{{.Category.Name}}</span>
              {{end}} {{if .IsCover}}
              <span class="category" style="background: #28a745">Cover</span>
              {{end}}
            </div>
          </div>
          {{end}}
        </div>
        {{else}}
        <p>No songs available yet.</p>
        {{end}}
      </main>
    </div>
    <script src="/static/js/theme-toggle.js"></script>
    <script src="/static/js/search-filter.js"></script>
    <script src="/static/js/artist-colors.js"></script>
    <script>
      // Initialize search and filter functionality
      const songsData = JSON.parse('{{.songsJSON}}');
      const categoriesData = JSON.parse('{{.categoriesJSON}}');

      const searchFilter = new FuzzySearchFilter({
        searchInputId: 'song-search',
        categoryFilterId: 'category-filter',
        itemsContainerId: 'songs-container',
        itemClass: 'song-card',
        noResultsId: 'no-results',
        data: songsData,
        categoriesData: categoriesData,
        searchFields: [
          'NameOriginal',
          'NameEnglish',
          'SourceURL',
          'Artists',  // Will search in Artists array
          'Units'     // Will search in Units array
        ],
        fuzzyThreshold: 15
      });

      // Update search stats
      function updateSearchStats() {
        const stats = document.getElementById('search-stats');
        const totalCount = songsData.length;
        const filteredCount = searchFilter.filteredData.length;

        if (filteredCount === totalCount) {
          stats.textContent = `${totalCount} songs total`;
        } else {
          stats.textContent = `${filteredCount} of ${totalCount} songs`;
        }
      }

      // Override the renderItems method to also update stats and apply artist colors
      const originalRenderItems = searchFilter.renderItems.bind(searchFilter);
      searchFilter.renderItems = function() {
        originalRenderItems();
        updateSearchStats();
        // Apply artist and unit colors after rendering
        initializeAllColors(this.filteredData);
      };

      // Initialize artist and unit colors on page load
      initializeAllColors(songsData);
    </script>
  </body>
</html>
{{end}}
