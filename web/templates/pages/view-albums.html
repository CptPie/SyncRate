{{define "view-albums.html"}}
<!doctype html>
<html lang="en">
  <head>
    {{template "head" .}}
  </head>
  <body>
    <div class="container">
      {{template "header" .}}
      <main>
        <div class="admin-header">
          <h2>View Albums</h2>
          <a href="/admin" class="btn-secondary">‚Üê Back to Admin</a>
        </div>

        <!-- Search and Filter -->
        <div class="search-filter-container">
          <div class="search-filter-row">
            <div class="search-group">
              <label for="album-search" class="form-label">Search Albums</label>
              <input type="text" id="album-search" class="search-input" placeholder="Search by album name...">
              <div class="search-stats" id="search-stats">{{len .albums}} albums total</div>
            </div>
            <div class="filter-group">
              <label for="category-filter" class="form-label">Filter by Category</label>
              <select id="category-filter" class="filter-select">
                <option value="">All Categories</option>
                {{range .categories}}
                <option value="{{.CategoryID}}">{{.Name}}</option>
                {{end}}
              </select>
            </div>
          </div>
        </div>

        <!-- No Results Message -->
        <div id="no-results" class="no-results" style="display: none;">
          <h3>No albums found</h3>
          <p>Try adjusting your search or filter criteria</p>
        </div>

        {{if .albums}}
        <div class="view-grid" id="albums-container">
          <!-- Albums will be rendered by JavaScript -->
        </div>

        <div class="pagination-controls">
          <button id="prev-page" class="btn-secondary">Previous</button>
          <span id="page-info"></span>
          <button id="next-page" class="btn-secondary">Next</button>
        </div>
        {{else}}
        <div class="empty-state">
          <p>No albums found.</p>
          <a href="/admin/add-album" class="btn-primary">Add First Album</a>
        </div>
        {{end}}
      </main>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Edit Album</h3>
          <button type="button" class="modal-close" onclick="closeEditModal()">&times;</button>
        </div>
        <form id="editForm" method="POST">
          <div class="form-group">
            <label for="edit_name_original" class="form-label">Album Name (original):</label>
            <input type="text" id="edit_name_original" name="name_original" required class="form-input" />
          </div>
          <div class="form-group">
            <label for="edit_name_english" class="form-label">Translated Name (optional):</label>
            <input type="text" id="edit_name_english" name="name_english" class="form-input" />
          </div>
          <div class="form-group">
            <label for="edit_album_art_url" class="form-label">Album Art URL (optional):</label>
            <input type="url" id="edit_album_art_url" name="album_art_url" class="form-input" />
          </div>
          <div class="form-group">
            <label for="edit_type" class="form-label">Type:</label>
            <select id="edit_type" name="type" class="form-input">
              <option value="">Select type...</option>
              <option value="Album">Album</option>
              <option value="Single">Single</option>
              <option value="EP">EP</option>
            </select>
          </div>
          <div class="form-group">
            <label for="edit_category_id" class="form-label">Category (optional):</label>
            <select id="edit_category_id" name="category_id" class="form-input">
              <option value="">No Category</option>
              {{range .categories}}
              <option value="{{.CategoryID}}">{{.Name}}</option>
              {{end}}
            </select>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn-secondary" onclick="closeEditModal()">Cancel</button>
            <button type="submit" class="btn-primary">Update Album</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Delete Album</h3>
          <button type="button" class="modal-close" onclick="closeDeleteModal()">&times;</button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete the album "<span id="deleteAlbumName"></span>"?</p>
          <p class="warning">This action cannot be undone.</p>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-secondary" onclick="closeDeleteModal()">Cancel</button>
          <form id="deleteForm" method="POST" style="display: inline;">
            <button type="submit" class="btn-danger">Delete Album</button>
          </form>
        </div>
      </div>
    </div>

    <script src="/static/js/theme-toggle.js"></script>
    <script src="/static/js/search-filter.js"></script>
    <script>
      const albumsData = JSON.parse("{{.albumsJSON}}");
      const categoriesData = JSON.parse("{{.categoriesJSON}}");

      // Render function for album cards
      function renderAlbumCard(album) {
        const songsCount = album.Songs ? album.Songs.length : 0;

        return `
          <div class="view-card" data-id="${album.AlbumID}">
            <div class="view-card-header">
              <h3>${album.NameOriginal}</h3>
              <div class="view-card-actions">
                <button class="btn-secondary edit-btn" onclick="openEditModal(${album.AlbumID})">Edit</button>
                <button class="btn-danger delete-btn" onclick="deleteAlbum(${album.AlbumID}, '${album.NameOriginal.replace(/'/g, "\\'")}')">Delete</button>
              </div>
            </div>
            <div class="view-card-details">
              ${album.NameEnglish ? `<p><strong>English Name:</strong> ${album.NameEnglish}</p>` : ''}
              ${album.AlbumArtURL ? `<div class="song-thumbnail"><img src="${album.AlbumArtURL}" alt="${album.NameOriginal}" class="song-card-image"></div>` : ''}
              ${album.Type ? `<p><strong>Type:</strong> <span class="badge">${album.Type}</span></p>` : ''}
              ${album.Category ? `<p><strong>Category:</strong> ${album.Category.Name}</p>` : ''}
              ${songsCount > 0 ? `<p><strong>Songs:</strong> ${songsCount}</p>` : ''}
              <p><strong>ID:</strong> ${album.AlbumID}</p>
              <p><strong>Created:</strong> ${new Date(album.CreatedAt).toLocaleString('en-CA', {year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false}).replace(',', '')}</p>
              ${album.CreatedAt !== album.UpdatedAt ? `<p><strong>Updated:</strong> ${new Date(album.UpdatedAt).toLocaleString('en-CA', {year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false}).replace(',', '')}</p>` : ''}
            </div>
          </div>
        `;
      }

      function openEditModal(albumId) {
        // Find the album in the data
        const currentAlbum = albumsData.find(album => album.AlbumID === albumId);
        if (!currentAlbum) return;

        // Populate form fields
        document.getElementById('edit_name_original').value = currentAlbum.NameOriginal || '';
        document.getElementById('edit_name_english').value = currentAlbum.NameEnglish || '';
        document.getElementById('edit_album_art_url').value = currentAlbum.AlbumArtURL || '';
        document.getElementById('edit_type').value = currentAlbum.Type || '';
        document.getElementById('edit_category_id').value = (currentAlbum.CategoryID) ? currentAlbum.CategoryID : '';

        // Set form action
        document.getElementById('editForm').action = '/admin/albums/' + albumId + '/edit';
        document.getElementById('editModal').style.display = 'flex';
      }

      function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
      }

      function deleteAlbum(id, name) {
        document.getElementById('deleteAlbumName').textContent = name;
        document.getElementById('deleteForm').action = '/admin/albums/' + id + '/delete';
        document.getElementById('deleteModal').style.display = 'flex';
      }

      function closeDeleteModal() {
        document.getElementById('deleteModal').style.display = 'none';
      }

      // Close modals when clicking outside
      window.onclick = function(event) {
        const editModal = document.getElementById('editModal');
        const deleteModal = document.getElementById('deleteModal');
        if (event.target === editModal) {
          closeEditModal();
        }
        if (event.target === deleteModal) {
          closeDeleteModal();
        }
      }

      // Update search stats function
      let searchFilter;
      function updateSearchStats() {
        const stats = document.getElementById('search-stats');
        if (!stats || !searchFilter) return;

        const totalCount = albumsData.length;
        const filteredCount = searchFilter.filteredData.length;

        if (filteredCount === totalCount) {
          stats.textContent = `${totalCount} albums total`;
        } else {
          stats.textContent = `${filteredCount} of ${totalCount} albums`;
        }
      }

      // Initialize search and filter functionality
      searchFilter = new FuzzySearchFilter({
        searchInputId: 'album-search',
        categoryFilterId: 'category-filter',
        itemsContainerId: 'albums-container',
        itemClass: 'view-card',
        noResultsId: 'no-results',
        data: albumsData,
        categoriesData: categoriesData,
        searchFields: [
          'NameOriginal',
          'NameEnglish',
          'Type'
        ],
        renderFunction: renderAlbumCard,
        itemsPerPage: 50,
        fuzzyThreshold: 15,
        onRenderComplete: function(pageData) {
          updateSearchStats();
        }
      });

      // Initial stats update
      updateSearchStats();
    </script>
  </body>
</html>
{{end}}
