{{define "song.html"}}
<!doctype html>
<html lang="en">
  <head>
    {{template "head" .}}
  </head>
  <body>
    <div class="container">
      {{template "header" .}}
      <main>
        <div class="song-detail-layout" data-song-id="{{.song.SongID}}">
          <div class="song-info">
            <div class="song-header">
              <div class="song-titles">
                <h2>{{.song.NameOriginal}}</h2>
                {{if .song.NameEnglish}}
                <h3 style="color: #666; margin-top: -10px">
                  {{.song.NameEnglish}}
                </h3>
                {{end}}
              </div>
              {{if gt .vote_count 0}}
              <div class="song-page-score">
                <div class="score-main">
                  <span class="score-value">{{printf "%.1f" .average_score}}</span>
                  <span class="score-max">/10</span>
                </div>
                <div class="score-subtitle">
                  {{if eq .vote_count 1}}1 vote{{else}}{{.vote_count}} votes{{end}}
                </div>
              </div>
              {{end}}
            </div>
            {{if .song.Artists}}
            <div class="artist">
              {{if eq (len .song.Artists) 1}}Artist{{else}}Artists{{end}}:
              {{range $index, $songArtist := .song.Artists}} {{if $index}}, {{end}}<span class="artist-name">{{$songArtist.NameOriginal}}</span> {{end}}
            </div>
            {{end}}

            {{if .song.Units}}
            <div class="units">
              {{if eq (len .song.Units) 1}}Group{{else}}Groups{{end}}:
              {{range $index, $songUnit := .song.Units}} {{if $index}}, {{end}}<span class="unit-name">{{$songUnit.NameOriginal}}</span> {{end}}
            </div>
            {{end}}

            {{if or .song.Category .song.IsCover}}
            <div class="categories">
              Tags:
              {{if .song.Category}}
              <span class="category">{{.song.Category.Name}}</span>
              {{end}} {{if .song.IsCover}}
              <span class="category" style="background: #28a745">Cover</span>
              {{end}}
            </div>
            {{end}}

            {{if .embedURL}}
            <div class="youtube-embed">
              <iframe
                src="{{.embedURL}}"
                frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen>
              </iframe>
            </div>
            {{end}}
          </div>

          <div class="song-sidebar">
            {{if .song.ThumbnailURL}}
            <img
              src="{{.song.ThumbnailURL}}"
              alt="{{.song.NameOriginal}}"
              class="song-image"
            />
            {{end}}

            {{if .is_authenticated}}
            <div class="rating-form">
              {{if .user_vote}}
              <h4>Update your rating</h4>
              <p><strong>Your current rating: {{.user_vote.Rating}}/10</strong></p>
              {{else}}
              <h4>Rate this song</h4>
              {{end}}
              <form action="/songs/{{.song.SongID}}/vote" method="POST">
                <select name="rating" required class="form-select">
                  <option value="" disabled {{if not .user_vote}}selected{{end}} hidden>
                    Select rating...
                  </option>
                  <option value="1" {{if and .user_vote (eq .user_vote.Rating 1)}}selected{{end}}>1 - Terrible</option>
                  <option value="2" {{if and .user_vote (eq .user_vote.Rating 2)}}selected{{end}}>2 - Poor</option>
                  <option value="3" {{if and .user_vote (eq .user_vote.Rating 3)}}selected{{end}}>3 - Below Average</option>
                  <option value="4" {{if and .user_vote (eq .user_vote.Rating 4)}}selected{{end}}>4 - Fair</option>
                  <option value="5" {{if and .user_vote (eq .user_vote.Rating 5)}}selected{{end}}>5 - Average</option>
                  <option value="6" {{if and .user_vote (eq .user_vote.Rating 6)}}selected{{end}}>6 - Above Average</option>
                  <option value="7" {{if and .user_vote (eq .user_vote.Rating 7)}}selected{{end}}>7 - Good</option>
                  <option value="8" {{if and .user_vote (eq .user_vote.Rating 8)}}selected{{end}}>8 - Very Good</option>
                  <option value="9" {{if and .user_vote (eq .user_vote.Rating 9)}}selected{{end}}>9 - Excellent</option>
                  <option value="10" {{if and .user_vote (eq .user_vote.Rating 10)}}selected{{end}}>10 - Perfect</option>
                </select>
                <textarea
                  name="comment"
                  placeholder="Optional comment..."
                  class="form-textarea"
                >{{if .user_vote}}{{.user_vote.Comment}}{{end}}</textarea>
                <button type="submit" class="btn-secondary">
                  {{if .user_vote}}Update Rating{{else}}Submit Rating{{end}}
                </button>
              </form>
            </div>
            {{else}}
            <div class="rating-form">
              <h4>Rate this song</h4>
              <p style="color: #666; margin: 10px 0;">
                <a href="/login">Login</a> to rate this song
              </p>
            </div>
            {{end}}
          </div>
        </div>

        {{if .votes}}
        <div class="votes-section">
          <h3>User Ratings</h3>
          {{range .votes}}
          <div class="vote-card">
            <div class="vote-header">
              <strong>{{.Username}}</strong>
              <span class="vote-rating">{{.Rating}}/10</span>
            </div>
            {{if .Comment}}
            <p class="vote-comment">{{.Comment}}</p>
            {{end}}
          </div>
          {{end}}
        </div>
        {{else}}
        <p style="margin-top: 40px; color: #666">
          No ratings yet. Be the first to rate this song!
        </p>
        {{end}}
      </main>
    </div>
    <script src="/static/js/theme-toggle.js"></script>
    <script src="/static/js/artist-colors.js"></script>
    <script>
      // Initialize colors for the single song
      try {
        const songJSON = '{{.songJSON}}';
        if (songJSON && songJSON.trim() !== '') {
          const songData = JSON.parse(songJSON);

          // Initialize artist and unit colors when page loads
          document.addEventListener('DOMContentLoaded', function() {
            if (songData && songData.length > 0) {
              initializeAllColors(songData);
            }
          });
        } else {
          console.log('No song JSON data available for color initialization');
        }
      } catch (e) {
        console.error('Error parsing song JSON:', e);
      }
    </script>
  </body>
</html>
{{end}}
